<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  i18n:domain="collective.cover">

  <body tal:define="is_empty view/is_empty; is_compose_mode python:
    view.is_compose_mode(); title python: view.data.get('title', '')">
    <p tal:condition="python: is_empty and is_compose_mode" i18n:translate="">
      Edit and select the source Sparql query from the portal.
    </p>

      <div class="edit_sparql_source" tal:condition="is_compose_mode" >
        <a tal:repeat="source view/get_sources"
          tal:attributes="href string:${source/absolute_url}/edit"
          target="_blank">Edit source</a>
      </div>

    <div tal:condition="not: is_empty" class="cover-foldercontentslisting-tile tile-content">

      <div class="tile-header" tal:define="text python: view.data.get('text', '')">
        <h4 class="title" tal:content="title">Relevant singlerows</h4>
        <div class="text" tal:condition="text" tal:content="structure text/output">Text</div>
      </div>

      <div class="cards" tal:define="children view/children">
        <div tal:repeat="obj python:children[:9]" tal:omit-tag="">
          <div tal:replace="structure python: view.render_cell(obj)" ></div>
        </div>
        <div tal:condition="not: children">
          Waiting for SPARQL data to arrive. Please reload page.
        </div>
      </div>
      <!-- TODO: this neds to be moved in separate file -->
      <script>
        /* <[CDATA[ */

  $(document).ready(function(){

    var $cell = $('.cardgraph');
    $cell.find('.js-expander').click(function() {

      var $thisCell = $(this).closest('.cardgraph');
      var $thiscard=$(this);

      if ($thisCell.hasClass('is-collapsed')) {
        $cell.not($thisCell).removeClass('is-expanded').addClass('is-collapsed').addClass('is-inactive');
        $thisCell.removeClass('is-collapsed').addClass('is-expanded');

        var $ifw = $thisCell.find('.iframe-wrapper');
        $ifw.html('');
        var iurl = $ifw.data('iframe-url');
        var width = $ifw.data('iframe-width');
        var height = $ifw.data('iframe-height');


        var iframe = document.createElement('iframe');
        iframe.src = iurl;
        iframe.style.width = width + 'px';
        iframe.style.height = height + 'px';
        iframe.onload = function() {
          iframe.parentNode.classList.remove('is-loading');
        }

        $ifw[0].appendChild(iframe);

        if ($cell.not($thisCell).hasClass('is-inactive')) {
          //do nothing
        } else {
          $cell.not($thisCell).addClass('is-inactive');
        }

      } else {
        $thisCell.removeClass('is-expanded').addClass('is-collapsed');
        $cell.not($thisCell).removeClass('is-inactive');
      }
    });

    $cell.find('.js-collapser').click(function() {
      var $thisCell = $(this).closest('.cardgraph');
      $thisCell.removeClass('is-expanded').addClass('is-collapsed');
      $cell.not($thisCell).removeClass('is-inactive');
    });

    $(".cardgraph").on('click', function(e){
      e.stopPropagation();
      var body=$('body')[0].getBoundingClientRect();
      var card=$(this)[0].getBoundingClientRect(),

        cardleft=card.left+($(this).outerWidth()-$(this).width())/2;
      bodywidth=body.width+($(this).outerWidth()-$(this).width())/2-14;

      $('.card__expander').css({
        'left' : -cardleft,
        'width': bodywidth
      });
      if($(e.target).parent().hasClass('card__inner')){
        var bodytop = $('body').scrollTop();
        $('body').animate({ scrollTop: bodytop + 350 }, 300);
      }
    });

    $(".fa-close").on('click', function(){
      var bodytop = $('body').scrollTop();
      $('body').animate({ scrollTop: bodytop - 350 }, 300);
    });


    $('.expand').on('click', function(){
      $('.indicator-cards').toggleClass('flex-row-warp');
      $('#left-button, #right-button').toggleClass('buttons-hide')
    });

    var outer = $('.singlerow-cards-wrapper');

    $('#left-button').click(function () {
      var leftPos = outer.scrollLeft();
      outer.animate({ scrollLeft: leftPos - 300 }, 300);
    });


    $('#right-button').click(function () {
      var leftPos = outer.scrollLeft();
      outer.animate({ scrollLeft: leftPos + 300 }, 300);
    });

  });
/* ]]> */
      </script>
    </div>
  </body>
</html>
